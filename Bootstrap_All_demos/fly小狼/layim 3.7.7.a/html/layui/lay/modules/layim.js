/** layui-v2.3.0 layim 3.7.7.a MIT License By https://www.layui.com */
layui.define(["layer","laytpl","upload"],function(M){var E="3.7.7.1";var au=layui.$;var G=layui.layer;var B=layui.laytpl;var an=layui.device();var Y="layui-show",ac="layim-this",ay=30,a=2,b=false;var K={};var y=function(){this.v=E;au("body").on("click","*[layim-event]",function(aF){var v=au(this),aG=v.attr("layim-event");t[aG]?t[aG].call(this,v,aF):""})};y.prototype.config=function(v){var aF=[];layui.each(Array(5),function(aG){aF.push(layui.cache.dir+"css/modules/layim/skin/"+(aG+1)+".jpg")});v=v||{};v.skin=v.skin||[];layui.each(v.skin,function(aG,aH){aF.unshift(aH)});v.skin=aF;v=au.extend({isfriend:!0,isgroup:!0,voice:"default.mp3",msgtypes:[{"name":"send","title":"发送中","color":"#DCDCDC","background":"#FBFBEA"},{"name":"reach","title":"送达","color":"#8D8A8A","background":"#DDF3FF"},{"name":"read","title":"已读","color":"#FFF","background":"#00B271"},{"name":"error","title":"失败","color":"#FFF","background":"#B45B3E"}]},v);if(!window.JSON||!window.JSON.parse){return}aa(v);b=true;return this};y.prototype.on=function(v,aF){if(typeof aF==="function"){K[v]?K[v].push(aF):K[v]=[aF]}return this};y.prototype.cache=function(){return D};y.prototype.chat=function(v){if(!window.JSON||!window.JSON.parse){return}return r(v),this};y.prototype.setChatMin=function(){return x(),this};y.prototype.setMainHide=function(){return z(),this};y.prototype.setMainShow=function(){return aq(),this};y.prototype.toggleMainDisplay=function(){return S(),this};y.prototype.imClose=function(){return aw(),this};y.prototype.getMsgStateView=function(aF,v){return ak(aF,v)};y.prototype.setMsgState=function(aG,aF,v){return Z(aG,aF,v),this};y.prototype.withdrawChat=function(v){return m(v),this};y.prototype.setChatStatus=function(aG){var aF=I();if(!aF){return}var v=aF.elem.find(".layim-chat-status");return v.html(aG),this};y.prototype.getMessage=function(v){return g(v),this};y.prototype.notice=function(v){return F(v),this};y.prototype.add=function(v){return ag(v),this};y.prototype.setFriendGroup=function(v){return ag(v,"setGroup"),this};y.prototype.msgbox=function(v){return w(v),this};y.prototype.addList=function(v){return aA(v),this};y.prototype.removeList=function(v){return Q(v),this};y.prototype.setFriendStatus=function(aK,aI,aG){var aJ=au(".layim-friend"+aK);aJ[aI==="online"?"removeClass":"addClass"]("layim-list-gray");if(!aG){var aF=au(".layim-list-friend .layim-friend"+aK);var aH=aF.parent(),v=aH.find("li");if(v.length>1){v.sort(function(aM,aL){if(!au(aM).hasClass("layim-list-gray")){return -1}else{if(au(aM).hasClass("layim-list-gray")&&!au(aL).hasClass("layim-list-gray")){return 1}else{if(!au(aM).hasClass("layim-list-gray")&&!au(aL).hasClass("layim-list-gray")){return -1}}}return -1});aH.empty();aH.append(v)}}};y.prototype.content=function(v){return layui.data.content(v)};var e=function(v){var aF={friend:"该分组下暂无好友",group:"暂无群组",history:"暂无历史会话"};v=v||{};v.item=v.item||("d."+v.type);return["{{# var length = 0; layui.each("+v.item+", function(i, data){ length++; }}",'<li layim-event="chat" data-type="'+v.type+'" data-index="{{ '+(v.index||"i")+' }}" class="layim-'+(v.type==="history"?"{{i}}":v.type+"{{data.id}}")+' {{ data.status === "offline" ? "layim-list-gray" : "" }}"><img src="{{ data.avatar }}"><span>{{ data.username||data.groupname||data.name||"佚名" }}</span><p>{{ data.remark||data.sign||"" }}</p><span class="layim-msg-status">new</span></li>',"{{# }); if(length === 0){ }}",'<li class="layim-null">'+(aF[v.type]||"暂无数据")+"</li>","{{# } }}"].join("")};var q=['<div class="layui-layim-main">','<div class="layui-layim-info">','<div class="layui-layim-user">{{ d.mine.username }}</div>',"{{# if(d.base && d.base.isStatus){ }}",'<div class="layui-layim-status">','{{# if(d.mine.status === "online"){ }}','<span class="layui-icon layim-status-online" layim-event="status" lay-type="show">&#xe617;</span>','{{# } else if(d.mine.status === "hide") { }}','<span class="layui-icon layim-status-hide" layim-event="status" lay-type="show">&#xe60f;</span>',"{{# } }}",'<ul class="layui-anim layim-menu-box">','<li {{d.mine.status === "online" ? "class=layim-this" : ""}} layim-event="status" lay-type="online"><i class="layui-icon layui-icon-ok"></i><cite class="layui-icon layim-status-online">&#xe617;</cite>在线</li>','<li {{d.mine.status === "hide" ? "class=layim-this" : ""}} layim-event="status" lay-type="hide"><i class="layui-icon layui-icon-ok"></i><cite class="layui-icon layim-status-hide">&#xe60f;</cite>隐身</li>',"</ul>","</div>","{{# }; }}",'<input class="layui-layim-remark" placeholder="编辑签名" value="{{ d.mine.remark||d.mine.sign||"" }}">',"</div>",'<ul class="layui-unselect layui-layim-tab{{# if(!d.base.isfriend || !d.base.isgroup){ }}'," layim-tab-two",'{{# } }}">','<li class="layui-icon',"{{# if(!d.base.isfriend){ }}"," layim-hide","{{# } else { }}"," layim-this","{{# } }}",'" title="联系人" layim-event="tab" lay-type="friend">&#xe612;</li>','<li class="layui-icon',"{{# if(!d.base.isgroup){ }}"," layim-hide","{{# } else if(!d.base.isfriend) { }}"," layim-this","{{# } }}",'" title="群组" layim-event="tab" lay-type="group">&#xe613;</li>','<li class="layui-icon" title="历史会话" layim-event="tab" lay-type="history">&#xe611;</li>',"</ul>",'<ul class="layui-unselect layim-tab-content {{# if(d.base.isfriend){ }}layui-show{{# } }} layim-list-friend">','{{# layui.each(d.friend, function(index, item){ var spread = d.local["spread"+index]; }}',"<li>",'<h5 layim-event="spread" lay-type="{{ spread }}"><i class="layui-icon">{{# if(spread === "true"){ }}&#xe61a;{{# } else {  }}&#xe602;{{# } }}</i><span>{{ item.groupname||"未命名分组"+index }}</span><em>(<cite class="layim-count"> {{ (item.list||[]).length }}</cite>)</em></h5>','<ul class="layui-layim-list {{# if(spread === "true"){ }}'," layui-show",'{{# } }}">',e({type:"friend",item:"item.list",index:"index"}),"</ul>","</li>","{{# }); if(d.friend.length === 0){ }}",'<li><ul class="layui-layim-list layui-show"><li class="layim-null">暂无联系人</li></ul>',"{{# } }}","</ul>",'<ul class="layui-unselect layim-tab-content {{# if(!d.base.isfriend && d.base.isgroup){ }}layui-show{{# } }}">',"<li>",'<ul class="layui-layim-list layui-show layim-list-group">',e({type:"group"}),"</ul>","</li>","</ul>",'<ul class="layui-unselect layim-tab-content  {{# if(!d.base.isfriend && !d.base.isgroup){ }}layui-show{{# } }}">',"<li>",'<ul class="layui-layim-list layui-show layim-list-history">',e({type:"history"}),"</ul>","</li>","</ul>",'<ul class="layui-unselect layim-tab-content">',"<li>",'<ul class="layui-layim-list layui-show" id="layui-layim-search"></ul>',"</li>","</ul>",'<ul class="layui-unselect layui-layim-tool">','<li class="layui-icon layim-tool-search" layim-event="search" title="搜索">&#xe615;</li>',"{{# if(d.base.msgbox){ }}",'<li class="layui-icon layim-tool-msgbox" layim-event="msgbox" title="消息盒子">&#xe645;<span class="layui-anim"></span></li>',"{{# } }}","{{# if(d.base.find){ }}",'<li class="layui-icon layim-tool-find" layim-event="find" title="查找">&#xe608;</li>',"{{# } }}",'<li class="layui-icon layim-tool-skin" layim-event="skin" title="更换背景">&#xe61b;</li>',"{{# if(!d.base.copyright){ }}",'<li class="layui-icon layim-tool-about" layim-event="about" title="关于">&#xe60b;</li>',"{{# } }}","</ul>",'<div class="layui-layim-search"><input><label class="layui-icon" layim-event="closeSearch">&#x1007;</label></div>',"</div>"].join("");var av=['<ul class="layui-layim-skin">',"{{# layui.each(d.skin, function(index, item){ }}",'<li><img layim-event="setSkin" src="{{ item }}"></li>',"{{# }); }}",'<li layim-event="setSkin"><cite>简约</cite></li>',"</ul>"].join("");var at=['<div class="layim-chat layim-chat-{{d.data.type}}{{d.first ? " layui-show" : ""}}">','<div class="layui-unselect layim-chat-title">','<div class="layim-chat-other">','<img class="layim-{{ d.data.type }}{{ d.data.id }}" src="{{ d.data.avatar }}"><span class="layim-chat-username" layim-event="{{ d.data.type==="group" ? "groupMembers" : "" }}">{{ d.data.name||"佚名" }} {{d.data.temporary ? "<cite>临时会话</cite>" : ""}} {{# if(d.data.type==="group"){ }} <em class="layim-chat-members"></em><i class="layui-icon">&#xe61a;</i> {{# } }}</span>','<p class="layim-chat-status"></p>',"</div>","</div>",'<div class="layim-chat-main">',"<ul></ul>","</div>",'<div class="layim-chat-footer">','<div class="layui-unselect layim-chat-tool" data-json="{{encodeURIComponent(JSON.stringify(d.data))}}">','<span class="layui-icon layim-tool-face" title="选择表情" layim-event="face">&#xe60c;</span>',"{{# if(d.base && d.base.uploadImage){ }}",'<span class="layui-icon layim-tool-image" title="上传图片" layim-event="image">&#xe60d;<input type="file" name="file"></span>',"{{# }; }}","{{# if(d.base && d.base.uploadFile){ }}",'<span class="layui-icon layim-tool-image" title="发送文件" layim-event="image" data-type="file">&#xe61d;<input type="file" name="file"></span>',"{{# }; }}","{{# if(d.base && d.base.isAudio){ }}",'<span class="layui-icon layim-tool-audio" title="发送网络音频" layim-event="media" data-type="audio">&#xe6fc;</span>',"{{# }; }}","{{# if(d.base && d.base.isVideo){ }}",'<span class="layui-icon layim-tool-video" title="发送网络视频" layim-event="media" data-type="video">&#xe6ed;</span>',"{{# }; }}","{{# layui.each(d.base.tool, function(index, item){ }}",'<span class="layui-icon layim-tool-{{item.alias}}" title="{{item.title}}" layim-event="extend" lay-filter="{{ item.alias }}">{{item.icon}}</span>',"{{# }); }}","{{# if(d.base && d.base.chatLog){ }}",'<span class="layim-tool-log" layim-event="chatLog"><i class="layui-icon">&#xe60e;</i>聊天记录</span>',"{{# }; }}","</div>",'<div class="layim-chat-textarea"><textarea></textarea></div>','<div class="layim-chat-bottom">','<div class="layim-chat-send">',"{{# if(!d.base.brief){ }}",'<span class="layim-send-close" layim-event="closeThisChat">关闭</span>',"{{# } }}",'<span class="layim-send-btn" layim-event="send">发送</span>','<span class="layim-send-set" layim-event="setSend" lay-type="show"><em class="layui-edge"></em></span>','<ul class="layui-anim layim-menu-box">','<li {{d.local.sendHotKey !== "Ctrl+Enter" ? "class=layim-this" : ""}} layim-event="setSend" lay-type="Enter"><i class="layui-icon layui-icon-ok"></i>按Enter键发送消息</li>','<li {{d.local.sendHotKey === "Ctrl+Enter" ? "class=layim-this" : ""}} layim-event="setSend"  lay-type="Ctrl+Enter"><i class="layui-icon layui-icon-ok"></i>按Ctrl+Enter键发送消息</li>',"</ul>","</div>","</div>","</div>","</div>"].join("");var u=['<div class="layim-add-box">','<div class="layim-add-img"><img class="layui-circle" src="{{ d.data.avatar }}"><p>{{ d.data.name||"" }}</p></div>','<div class="layim-add-remark">','{{# if(d.data.type === "friend" && d.type === "setGroup"){ }}',"<p>选择分组</p>",'{{# } if(d.data.type === "friend"){ }}','<select class="layui-select" id="LAY_layimGroup">',"{{# layui.each(d.data.group, function(index, item){ }}",'<option value="{{ item.id }}">{{ item.groupname }}</option>',"{{# }); }}","</select>","{{# } }}",'{{# if(d.data.type === "group"){ }}',"<p>请输入验证信息</p>",'{{# } if(d.type !== "setGroup"){ }}','<textarea id="LAY_layimRemark" placeholder="验证信息" class="layui-textarea"></textarea>',"{{# } }}","</div>","</div>"].join("");var X=['<li {{ d.mine ? "class=layim-chat-mine" : "" }} {{# if(d.cid){ }}data-cid="{{d.cid}}"{{# } }} data-mine="{{d.mine || false}}" >','<div class="layim-chat-user"><img src="{{ d.avatar }}"><cite>',"{{# if(d.mine){ }}","{{# if(d.cid && d.state ){ }}","{{# d.msghtml = layui.layim.getMsgStateView(d.state,layui.layim.cache().base.isMsgState); }}","{{d.msghtml}}","{{# } }}",'<i>{{ layui.data.date(d.timestamp) }}</i>{{ d.username||"佚名" }}',"{{# } else { }}",'{{ d.username||"佚名" }}<i>{{ layui.data.date(d.timestamp) }}</i>',"{{# } }}","</cite></div>",'<div class="layim-chat-text">{{ layui.data.content(d.content||"&nbsp") }}</div>',"</li>"].join("");var af='<li class="layim-{{ d.data.type }}{{ d.data.id }} layim-chatlist-{{ d.data.type }}{{ d.data.id }} layim-this" layim-event="tabChat"><img src="{{ d.data.avatar }}"><span>{{ d.data.name||"佚名" }}</span>{{# if(!d.base.brief){ }}<i class="layui-icon" layim-event="closeChat">&#x1007;</i>{{# } }}</li>';var c=function(v){return v<10?"0"+(v|0):v};layui.data.date=function(v){var aF=new Date(v||new Date());return aF.getFullYear()+"-"+c(aF.getMonth()+1)+"-"+c(aF.getDate())+" "+c(aF.getHours())+":"+c(aF.getMinutes())+":"+c(aF.getSeconds())};layui.data.content=function(aF){var v=function(aG){return new RegExp("\\n*\\["+(aG||"")+"(code|pre|div|span|p|table|thead|th|tbody|tr|td|ul|li|ol|li|dl|dt|dd|h2|h3|h4|h5)([\\s\\S]*?)\\]\\n*","g")};aF=(aF||"").replace(/&(?!#?[a-zA-Z0-9]+;)/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/'/g,"&#39;").replace(/"/g,"&quot;").replace(/@(\S+)(\s+?|$)/g,'@<a href="javascript:;">$1</a>$2').replace(/face\[([^\s\[\]]+?)\]/g,function(aG){var aH=aG.replace(/^face/g,"");return'<img alt="'+aH+'" title="'+aH+'" src="'+n[aH]+'">'}).replace(/img\[([^\s]+?)\]/g,function(aG){return'<img class="layui-layim-photos" src="'+aG.replace(/(^img\[)|(\]$)/g,"")+'">'}).replace(/file\([\s\S]+?\)\[[\s\S]*?\]/g,function(aI){var aG=(aI.match(/file\(([\s\S]+?)\)\[/)||[])[1];var aH=(aI.match(/\)\[([\s\S]*?)\]/)||[])[1];if(!aG){return aI}return'<a class="layui-layim-file" href="'+aG+'" download target="_blank"><i class="layui-icon">&#xe61e;</i><cite>'+(aH||aG)+"</cite></a>"}).replace(/audio\[([^\s]+?)\]/g,function(aG){return'<div class="layui-unselect layui-layim-audio" layim-event="playAudio" data-src="'+aG.replace(/(^audio\[)|(\]$)/g,"")+'"><i class="layui-icon">&#xe652;</i><p>音频消息</p></div>'}).replace(/video\[([^\s]+?)\]/g,function(aG){return'<div class="layui-unselect layui-layim-video" layim-event="playVideo" data-src="'+aG.replace(/(^video\[)|(\]$)/g,"")+'"><i class="layui-icon">&#xe652;</i></div>'}).replace(/a\([\s\S]+?\)\[[\s\S]*?\]/g,function(aI){var aG=(aI.match(/a\(([\s\S]+?)\)\[/)||[])[1];var aH=(aI.match(/\)\[([\s\S]*?)\]/)||[])[1];if(!aG){return aI}return'<a href="'+aG+'" target="_blank">'+(aH||aG)+"</a>"}).replace(v(),"<$1 $2>").replace(v("/"),"</$1>").replace(/\n/g,"<br>");return aF};var l=function(aF,aG,v){aF=aF||{};return au.ajax({url:aF.url,type:aF.type||"get",data:aF.data,dataType:aF.dataType||"json",cache:false,success:function(aH){aH.code==0?aG&&aG(aH.data||{}):G.msg(aH.msg||((v||"Error")+": LAYIM_NOT_GET_DATA"),{time:5000})},error:function(aH,aI){window.console&&console.log&&console.error("LAYIM_DATE_ERROR："+aI)}})};var D={message:{},chat:[]},aa=function(v){var aF=v.init||{};mine=aF.mine||{},local=layui.data("layim")[mine.id]||{},obj={base:v,local:local,mine:mine,history:local.history||{}},create=function(aH){var aJ=aH.mine||{};var aG=layui.data("layim")[aJ.id]||{},aI={base:v,local:aG,mine:aJ,friend:aH.friend||[],group:aH.group||[],history:aG.history||{}};D=au.extend(D,aI);ad(B(q).render(aI));if(aG.close||v.min){J()}layui.each(K.ready,function(aK,aL){aL&&aL(aI)});ah()};D=au.extend(D,obj);if(v.brief){return layui.each(K.ready,function(aG,aH){aH&&aH(obj)})}aF.url?l(aF,create,"INIT"):create(aF)};var L,ad=function(v){return G.open({type:1,area:["260px","520px"],skin:"layui-box layui-layim",title:"&#8203;",offset:"rb",id:"layui-layim",shade:false,anim:2,resize:false,maxmin:true,content:v,success:function(aG){L=aG;L.mainDisplay=true;W(aG);if(D.base.right){aG.css("margin-left","-"+D.base.right)}if(ax){G.close(ax.attr("times"))}L.find(".layui-layer-max").remove();var aF=[],aH=aG.find(".layim-list-history");aH.find("li").each(function(){aF.push(au(this).prop("outerHTML"))});if(aF.length>0){aF.reverse();aH.html(aF.join(""))}am();t.sign()},cancel:function(aF){z();return false},min:function(aF){J();var aG=layui.data("layim")[D.mine.id]||{};aG.close=true;layui.data("layim",{key:D.mine.id,value:aG});return false}})};var am=function(){L.on("contextmenu",function(aF){aF.cancelBubble=true;aF.returnValue=false;return false});var v=function(){G.closeAll("tips")};L.find(".layim-list-history").on("contextmenu","li",function(aH){var aG=au(this);var aF='<ul data-id="'+aG[0].id+'" data-index="'+aG.data("index")+'"><li layim-event="menuHistory" data-type="one">移除该会话</li><li layim-event="menuHistory" data-type="all">清空全部会话列表</li></ul>';if(aG.hasClass("layim-null")){return}G.tips(aF,this,{tips:1,time:0,anim:5,fixed:true,skin:"layui-box layui-layim-contextmenu",success:function(aI){var aJ=function(aK){k(aK)};aI.off("mousedown",aJ).on("mousedown",aJ)}});au(document).off("mousedown",v).on("mousedown",v);au(window).off("resize",v).on("resize",v)});au("#layui-layim-chat").on("contextmenu",function(aF){aF.cancelBubble=true;aF.returnValue=false;return false});L.find(".layim-chat-main").on("contextmenu","li",function(aH){var aG=au(this);var aF='<ul data-id="'+aG[0].id+'" data-index="'+aG.data("index")+'"><li layim-event="menuHistory" data-type="one">移除该会话</li><li layim-event="menuHistory" data-type="all">清空全部会话列表</li></ul>';if(aG.hasClass("layim-null")){return}G.tips(aF,this,{tips:1,time:0,anim:5,fixed:true,skin:"layui-box layui-layim-contextmenu",success:function(aI){var aJ=function(aK){k(aK)};aI.off("mousedown",aJ).on("mousedown",aJ)}});au(document).off("mousedown",v).on("mousedown",v);au(window).off("resize",v).on("resize",v)})};var p=function(){var v=function(){G.closeAll("tips")};s.on("contextmenu",function(aF){aF.cancelBubble=true;aF.returnValue=false;return false});s.find(".layim-chat-main").on("contextmenu","li",function(aJ){var aI=au(this);var aF=au(this).find(".layim-chat-text");if(aI.length==1&&aF){var aM=aI.data("cid");var aL=aI.data("mine");var aK=h(aM);var aH=aK?aK.state:"unknown";if(aM&&aK){var aG='<ul data-cid="'+aM+'" ><li layim-event="menuChat" data-type="del">删除</li>'+((D.base.openWithdraw&&aL)?'<li layim-event="menuChat" data-type="withdraw">撤回</li>':"")+((aL&&("error"===aH))?'<li layim-event="menuChat" data-type="resend">重发</li>':"")+"</ul>";if(aI.hasClass("layim-null")){return}G.tips(aG,aF,{tips:1,time:0,anim:5,fixed:false,skin:"layui-box layui-layim-contextmenu",success:function(aN){var aO=function(aP){k(aP)};aN.off("mousedown",aO).on("mousedown",aO)}});au(document).off("mousedown",v).on("mousedown",v);au(window).off("resize",v).on("resize",v)}}})};var ax,J=function(v){if(ax){G.close(ax.attr("times"))}if(L){L.hide();L.mainDisplay=false}D.mine=D.mine||{};return G.open({type:1,title:false,id:"layui-layim-close",skin:"layui-box layui-layim-min layui-layim-close",shade:false,closeBtn:false,anim:2,offset:"rb",resize:false,content:'<img src="'+(D.mine.avatar||(layui.cache.dir+"css/pc/layim/skin/logo.jpg"))+'"><span>'+(v||D.base.title||"我的LayIM")+"</span>",move:"#layui-layim-close img",success:function(aF,aG){ax=aF;if(D.base.right){aF.css("margin-left","-"+D.base.right)}aF.on("click",function(){G.close(aG);L.show();L.mainDisplay=true;var aH=layui.data("layim")[D.mine.id]||{};delete aH.close;layui.data("layim",{key:D.mine.id,value:aH})})}})};var s,aD,ai,ar={},r=function(aK){aK=aK||{};if(!b){return}var v=au("#layui-layim-chat"),aG={data:aK,base:D.base,local:D.local};if(!aK.id){return G.msg("非法用户")}if(v[0]){var aJ=s.find(".layim-chat-list");var aH=aJ.find(".layim-chatlist-"+aK.type+aK.id);var aL=s.find(".layui-layer-max").hasClass("layui-layer-maxmin");var aI=v.children(".layim-chat-box");if(s.css("display")==="none"){s.show()}if(aD){G.close(aD.attr("times"))}if(aJ.find("li").length===1&&!aH[0]){aL||s.css("width",800);aJ.css({height:s.height()}).show();aI.css("margin-left","200px")}if(!aH[0]){aJ.append(B(af).render(aG));aI.append(B(at).render(aG));R(aK);al()}az(aJ.find(".layim-chatlist-"+aK.type+aK.id));aH[0]||f();V(aK);ae();p();return ai}aG.first=!0;var aF=ai=G.open({type:1,area:"600px",skin:"layui-box layui-layim-chat",id:"layui-layim-chat",title:"&#8203;",shade:false,maxmin:true,offset:aK.offset||"auto",anim:aK.anim||0,closeBtn:D.base.brief?false:1,content:B('<ul class="layui-unselect layim-chat-list">'+af+'</ul><div class="layim-chat-box">'+at+"</div>").render(aG),success:function(aM){s=aM;aM.css({"min-width":"500px","min-height":"420px"});R(aK);typeof aK.success==="function"&&aK.success(aM);ae();W(aM);V(aK);f();N();C(I());p();layui.each(K.chatChange,function(aN,aO){aO&&aO(I())});aM.on("dblclick",".layui-layim-photos",function(){var aN=this.src;G.close(r.photosIndex);G.photos({photos:{data:[{"alt":"大图模式","src":aN}]},shade:0.01,closeBtn:2,anim:0,resize:false,success:function(aO,aP){r.photosIndex=aP}})})},full:function(aM){G.style(aF,{width:"100%",height:"100%"},true);al()},resizing:al,restore:al,min:function(){x();return false},end:function(){G.closeAll("tips");s=null}});return aF};var R=function(v){au(".layim-"+v.type+v.id).each(function(){if(au(this).hasClass("layim-list-gray")){layui.layim.setFriendStatus(v.id,"offline",true)}})};var al=function(){var aG=s.find(".layim-chat-list"),aF=s.find(".layim-chat-main"),v=s.height();aG.css({height:v});aF.css({height:v-20-80-158})};var z=function(){if(L){L.hide();L.mainDisplay=false}};var aq=function(){if(L){L.show();L.mainDisplay=true;if(ax){G.close(ax.attr("times"))}}};var S=function(){if(L){if(undefined!=L.mainDisplay){if(L.mainDisplay){z()}else{aq()}}}};var aw=function(){if(L){L.remove();if(ax){ax.remove()}if(s){s.remove()}}au(".layui-layim-min").remove();b=false};var j=function(aG,aH,aK){var aF=layui.data("layim")[D.mine.id]||{};var aJ=aG+aH;var aI=null;var v=aF.chatlog?aF.chatlog[aJ]:undefined;if(v){layui.each(v,function(aL,aM){if(aM.cid===aK){aI=aM;return true}})}return aI};var P=function(aL){var aK=null;var aH=(typeof aL==="string")?aL:JSON.stringify(aL);var v=aH.split("-");if(v.length==5){var aF=v[0],aJ=v[1],aG=v[2],aI=aF;if(aF===D.mine.id||aG!=="friend"){aI=aJ}aK=aG+aI}return aK};var h=function(aI){var aH=null;if(aI){var aF=layui.data("layim")[D.mine.id]||{};var aG=P(aI);var v=aF.chatlog?aF.chatlog[aG]:undefined;if(v){layui.each(v,function(aJ,aK){if(aK.cid===aI){aH=aK;return true}})}}return aH};var aj=function(aH){var aF=layui.data("layim")[D.mine.id]||{};var aG=aH.type+aH.id;var v=aF.chatlog?aF.chatlog[aG]:undefined;if(v){var aI=[];layui.each(v,function(aJ,aK){if(aK.cid!=aH.cid){aI.push(aK)}});aF.chatlog[aG]=aI;layui.data("layim",{key:D.mine.id,value:aF});s.find(".layim-chat-main").find("li[data-cid="+aH.cid+"]").remove();return true}return false};var aB=function(v){if(v instanceof Object){if(aj(v)){g({system:true,id:v.id,type:v.type,content:v.username+"撤回一条消息"})}}};var m=function(aF){var v=h(aF);aB(v)};var ak=function(aH,aF){if("sending"===aH){return'<span class="layui-icon layui-icon-loading layui-icon layui-anim layui-anim-rotate layui-anim-loop '+(aF?"":"layui-hide")+'" style="margin: 0 3px 0 3px;" title="准备发送"></span>'}else{if("error"===aH){return'<span class="layui-icon layui-icon-tips" style="color:red;margin: 0 3px 0 3px;" title="发送失败"></span>'}}var aG="";var v=D.base.msgtypes;if(v instanceof Array){layui.each(v,function(aI,aJ){if(aH===aJ.name){aG='<span title="消息发送状态" style="background-color: '+(aJ.background||"#fff")+";color: "+(aJ.color||"#ccc")+';margin: 0 5px 0 5px;padding: 0 5px 0 5px;" class="layui-btn-radius '+(aF?"":"layui-hide")+'">'+aJ.title+"</span>";return true}})}return aG};var Z=function(aL,aI,aH){if(aL&&aI){var aG=ak(aI,D.base.isMsgState);if(aG.length>0){var aF=layui.data("layim")[D.mine.id]||{};var aJ=P(aL);var v=aF.chatlog?aF.chatlog[aJ]:undefined;if(v){var aK=[];layui.each(v,function(aM,aN){if(aN.cid==aL){aN.state=aI;if(aH){aN.timestamp=aH}}aK.push(aN)});aF.chatlog[aJ]=aK;layui.data("layim",{key:D.mine.id,value:aF});s.find(".layim-chat-main").find("li[data-cid="+aL+"]").find("span").replaceWith(aG);if(aH){s.find(".layim-chat-main").find("li[data-cid="+aL+"]").find(".layim-chat-user i").html(layui.data.date(aH))}}}}};var x=function(aF){var v=aF||I().data,aG=layui.layim.cache().base;if(s&&!aF){s.hide()}G.close(x.index);x.index=G.open({type:1,title:false,skin:"layui-box layui-layim-min",shade:false,closeBtn:false,anim:v.anim||2,offset:"b",move:"#layui-layim-min",resize:false,area:["182px","50px"],content:'<img id="layui-layim-min" src="'+v.avatar+'"><span>'+v.name+"</span>",success:function(aH,aI){if(!aF){aD=aH}if(aG.minRight){G.style(aI,{left:au(window).width()-aH.outerWidth()-parseFloat(aG.minRight)})}aH.find(".layui-layer-content span").on("click",function(){G.close(aI);aF?layui.each(D.chat,function(aJ,aK){r(aK)}):s.show();if(aF){D.chat=[];ab()}});aH.find(".layui-layer-content img").on("click",function(aJ){k(aJ)})}})};var ag=function(aF,v){aF=aF||{};G.close(ag.index);return ag.index=G.open({type:1,area:"430px",title:{friend:"添加好友",group:"加入群组"}[aF.type]||"",shade:false,resize:false,btn:v?["确认","取消"]:["发送申请","关闭"],content:B(u).render({data:{name:aF.username||aF.groupname,avatar:aF.avatar,group:aF.group||parent.layui.layim.cache().friend||[],type:aF.type},type:v}),yes:function(aI,aG){var aH=aG.find("#LAY_layimGroup"),aJ=aG.find("#LAY_layimRemark");if(v){aF.submit&&aF.submit(aH.val(),aI)}else{aF.submit&&aF.submit(aH.val(),aJ.val(),aI)}}})};var az=function(aI,aF){aI=aI||au(".layim-chat-list ."+ac);var aG=aI.index()===-1?0:aI.index();var aJ=".layim-chat",v=s.find(aJ).eq(aG);var aK=s.find(".layui-layer-max").hasClass("layui-layer-maxmin");if(aF){if(aI.hasClass(ac)){az(aG===0?aI.next():aI.prev())}var aH=s.find(aJ).length;if(aH===1){return G.close(ai)}aI.remove();v.remove();if(aH===2){s.find(".layim-chat-list").hide();if(!aK){s.css("width","600px")}s.find(".layim-chat-box").css("margin-left",0)}return false}aI.addClass(ac).siblings().removeClass(ac);v.addClass(Y).siblings(aJ).removeClass(Y);v.find("textarea").focus();C(I());layui.each(K.chatChange,function(aL,aM){aM&&aM(I())});N()};var N=function(){var v=I();var aF=D.message[v.data.type+v.data.id];if(aF){delete D.message[v.data.type+v.data.id]}};var I=y.prototype.thisChat=function(){if(!s){return}var aF=au(".layim-chat-list ."+ac).index();var v=s.find(".layim-chat").eq(aF);var aG=JSON.parse(decodeURIComponent(v.find(".layim-chat-tool").data("json")));return{elem:v,data:aG,textarea:v.find("textarea")}};var W=function(v){var aF=layui.data("layim")[D.mine.id]||{},aG=aF.skin;v.css({"background-image":aG?"url("+aG+")":function(){return D.base.initSkin?"url("+(layui.cache.dir+"css/modules/layim/skin/"+D.base.initSkin)+")":"none"}()})};var V=function(aG){var v=layui.data("layim")[D.mine.id]||{};var aI={},aH=v.history||{};var aF=aH[aG.type+aG.id];if(!L){return}var aJ=L.find(".layim-list-history");aG.historyTime=new Date().getTime();aH[aG.type+aG.id]=aG;v.history=aH;layui.data("layim",{key:D.mine.id,value:v});if(aF){return}aI[aG.type+aG.id]=aG;var aK=B(e({type:"history",item:"d.data"})).render({data:aI});aJ.prepend(aK);aJ.find(".layim-null").remove()};var ao=function(aK,aH,aF){var aI={username:D.mine?D.mine.username:"访客",avatar:D.mine?D.mine.avatar:(layui.cache.dir+"css/pc/layim/skin/logo.jpg"),id:D.mine?D.mine.id:null,mine:true,senddate:new Date(),state:"sending"};var v=I();aI.content=aH;aI.cid=aK;var aJ={mine:aI,to:v.data},aG={username:aJ.mine.username,avatar:aJ.mine.avatar,id:aJ.to.id,type:aJ.to.type,content:aJ.mine.content,cid:aJ.mine.cid,timestamp:new Date().getTime(),state:aJ.mine.state,mine:true,fromid:aJ.mine.id};T(aG);if(aF){aF.append(B(X).render(aG))}layui.each(K.sendMessage,function(aL,aM){aM&&aM(aJ)});return aG};var H=function(v){var aG=D.mine?D.mine.id:null;var aF=aG+"-"+v.data.id+"-"+v.data.type+"-"+(new Date().getTime())+"-"+Math.floor(Math.random()*(8998)+1001);return aF};var i=function(){var aF=I(),aG=aF.elem.find(".layim-chat-main ul");var v=D.base.maxLength||3000;var aH=aF.textarea.val();if(aH.replace(/\s/g,"")!==""){if(aH.length>v){return G.msg("内容最长不能超过"+v+"个字符")}ao(H(aF),aH,aG)}ab();aF.textarea.val("").focus()};var F=function(v){v=v||{};if(window.Notification){if(Notification.permission==="granted"){var aF=new Notification(v.title||"",{body:v.content||"",icon:v.avatar||"http://tp2.sinaimg.cn/5488749285/50/5719808192/1"})}else{Notification.requestPermission()}}};var ap=function(){if(an.ie&&an.ie<9){return}var v=document.createElement("audio");v.src=layui.cache.dir+"css/modules/layim/voice/"+D.base.voice;v.play()};var aE={},g=function(aH){aH=aH||{};if(!b){return}if(!(aH.type&&aH.id)){console.log("getMessage data not is [id] or [type]");return}var aF=au(".layim-chatlist-"+aH.type+aH.id);var aL={},aI=aF.index();aH.timestamp=aH.timestamp||new Date().getTime();if(aH.cid){var v=h(aH.cid);if(null!=v){if(aH.fromid==D.mine.id){if(D.base.openMineMsg){}else{return}}else{console.log("getMessage data repeat ");return}}}if(D.base.isCacheSystem){T(aH)}else{aH.system||T(aH)}aE=JSON.parse(JSON.stringify(aH));if(D.base.voice){ap()}if((!s&&aH.content)||aI===-1){if(D.message[aH.type+aH.id]){D.message[aH.type+aH.id].push(aH)}else{D.message[aH.type+aH.id]=[aH];if(aH.type==="friend"){var aG;layui.each(D.friend,function(aP,aO){layui.each(aO.list,function(aQ,aR){if(aR.id==aH.id){aR.type="friend";aR.name=aR.username;D.chat.push(aR);return aG=true}});if(aG){return true}});if(!aG){aH.name=aH.username;aH.temporary=true;D.chat.push(aH)}}else{if(aH.type==="group"){var aN;layui.each(D.group,function(aO,aP){if(aP.id==aH.id){aP.type="group";aP.name=aP.groupname;D.chat.push(aP);return aN=true}});if(!aN){aH.name=aH.groupname;D.chat.push(aH)}}else{aH.name=aH.name||aH.username||aH.groupname;D.chat.push(aH)}}}if(aH.type==="group"){layui.each(D.group,function(aO,aP){if(aP.id==aH.id){aL.avatar=aP.avatar;return true}})}if(!aH.system){A(aH);if(D.base.notice){F({title:"来自 "+aH.username+" 的消息",content:aH.content,avatar:aL.avatar||aH.avatar})}return x({name:"收到新消息",avatar:aL.avatar||aH.avatar,anim:6})}}if(!s){return}var aK=I();if(aK.data.type+aK.data.id!==aH.type+aH.id){A(aH);aF.addClass("layui-anim layer-anim-06");setTimeout(function(){aF.removeClass("layui-anim layer-anim-06")},300)}else{d(aH)}var aM=s.find(".layim-chat").eq(aI);var aJ=aM.find(".layim-chat-main ul");if(aH.system){if(aI!==-1){aJ.append('<li class="layim-chat-system"><span>'+aH.content+"</span></li>")}}else{if(aH.content.replace(/\s/g,"")!==""){aJ.append(B(X).render(aH))}}ab()};var U="layui-anim-loop layer-anim-05",w=function(v){var aF=L.find(".layim-tool-msgbox");aF.find("span").addClass(U).html(v)};var T=function(aH){var aF=layui.data("layim")[D.mine.id]||{};aF.chatlog=aF.chatlog||{};var v=aF.chatlog[aH.type+aH.id];if(v){var aI;var aG=0;layui.each(v,function(aJ,aK){if((aK.timestamp===aH.timestamp&&aK.type===aH.type&&aK.id===aH.id&&aK.content===aH.content)){aI=true}if(!aK.system){aG+=1}});if(!aI){v.push(aH)}if(aG>ay){v.shift()}}else{aF.chatlog[aH.type+aH.id]=[aH]}layui.data("layim",{key:D.mine.id,value:aF})};var A=function(aH){var aF=layui.data("layim")[D.mine.id]||{};aF.unread=aF.unread||{};var v=aF.unread[aH.type+aH.id];if(v){var aG;layui.each(v,function(aI,aJ){if((aJ.cid===aH.cid)){aG=true}});if(!(aG||aH.fromid==D.mine.id)){v.push(aH)}}else{aF.unread[aH.type+aH.id]=[aH]}layui.data("layim",{key:D.mine.id,value:aF});ah()};var d=function(v){if(!v.system){layui.each(K.readchat,function(aF,aG){aG&&aG(v)})}};var C=function(aF){var aG=layui.data("layim")[D.mine.id]||{};aG.unread=aG.unread||{};var v=aG.unread[aF.data.type+aF.data.id];if(v){layui.each(v,function(aH,aI){d(aI)})}delete aG.unread[aF.data.type+aF.data.id];layui.data("layim",{key:D.mine.id,value:aG});ah()};var ah=function(){if(D.base.openUnReadAwoke&&L){var aH=L.find(".layim-list-friend .layui-layim-list li");var v=L.find(".layim-list-group li");var aG=layui.data("layim")[D.mine.id]||{};var aF=aG.unread||{};layui.each(aH,function(aI,aJ){o(aF,aJ)});layui.each(v,function(aI,aJ){o(aF,aJ)})}};var o=function(aF,aI){if(!au(aI).hasClass("layim-null")){var v=au(aI).attr("class").trim().split(" ")[0].trim();var aG=v.split("-");if(aG.length==2){var aJ=undefined,aH=undefined;if(aG[1].startsWith("friend")){aJ=aG[1].split("friend")[1];aH="friend"}else{if(aG[1].startsWith("group")){aJ=aG[1].split("group")[1];aH="group"}}if(aJ&&aH){if(aF[aH+aJ]){au(aI).find(".layim-msg-status").show();L.find(".layim-list-history ."+v).find(".layim-msg-status").show()}else{au(aI).find(".layim-msg-status").hide();L.find(".layim-list-history ."+v).find(".layim-msg-status").hide()}}}}};var f=function(){var aG=layui.data("layim")[D.mine.id]||{},v=I(),aH=aG.chatlog||{},aF=v.elem.find(".layim-chat-main ul");layui.each(aH[v.data.type+v.data.id],function(aI,aJ){if(aJ.system){aF.append('<li class="layim-chat-system"><span>'+aJ.content+"</span></li>")}else{aF.append(B(X).render(aJ))}});ab()};var aA=function(aK){var aL={},aG,aI=L.find(".layim-list-"+aK.type);if(D[aK.type]){if(aK.type==="friend"){layui.each(D.friend,function(aM,aN){if(aK.groupid==aN.id){layui.each(D.friend[aM].list,function(aO,aP){if(aP.id==aK.id){return aG=true}});if(aG){return G.msg("好友 ["+(aK.username||"")+"] 已经存在列表中",{anim:6})}D.friend[aM].list=D.friend[aM].list||[];aL[D.friend[aM].list.length]=aK;aK.groupIndex=aM;D.friend[aM].list.push(aK);return true}})}else{if(aK.type==="group"){layui.each(D.group,function(aM,aN){if(aN.id==aK.id){return aG=true}});if(aG){return G.msg("您已是 ["+(aK.groupname||"")+"] 的群成员",{anim:6})}aL[D.group.length]=aK;D.group.push(aK)}}}if(aG){return}var aJ=B(e({type:aK.type,item:"d.data",index:aK.type==="friend"?"data.groupIndex":null})).render({data:aL});if(aK.type==="friend"){var v=aI.find(">li").eq(aK.groupIndex);v.find(".layui-layim-list").append(aJ);v.find(".layim-count").html(D.friend[aK.groupIndex].list.length);if(v.find(".layim-null")[0]){v.find(".layim-null").remove()}var aH=v.find(".layui-layim-list"),aF=aH.find("li");if(aF.length>1){aF.sort(function(aN,aM){if(!au(aN).hasClass("layim-list-gray")){return -1}else{if(au(aN).hasClass("layim-list-gray")&&!au(aM).hasClass("layim-list-gray")){return 1}else{if(!au(aN).hasClass("layim-list-gray")&&!au(aM).hasClass("layim-list-gray")){return -1}}}return -1});aH.empty();aH.append(aF)}}else{if(aK.type==="group"){aI.append(aJ);if(aI.find(".layim-null")[0]){aI.find(".layim-null").remove()}}}};var Q=function(aF){var v=L.find(".layim-list-"+aF.type);var aG={};if(D[aF.type]){if(aF.type==="friend"){layui.each(D.friend,function(aI,aH){layui.each(aH.list,function(aK,aL){if(aF.id==aL.id){var aJ=v.find(">li").eq(aI);var aM=aJ.find(".layui-layim-list>li");aJ.find(".layui-layim-list>li").eq(aK).remove();D.friend[aI].list.splice(aK,1);aJ.find(".layim-count").html(D.friend[aI].list.length);if(D.friend[aI].list.length===0){aJ.find(".layui-layim-list").html('<li class="layim-null">该分组下已无好友了</li>')}return true}})})}else{if(aF.type==="group"){layui.each(D.group,function(aH,aI){if(aF.id==aI.id){v.find(">li").eq(aH).remove();D.group.splice(aH,1);if(D.group.length===0){v.html('<li class="layim-null">暂无群组</li>')}return true}})}}}};var ab=function(){var v=I(),aH=v.elem.find(".layim-chat-main");var aF=aH.find("ul");var aG=aF.find("li").length;if(aG>=ay){var aI=aF.find("li").eq(0);if(!aF.prev().hasClass("layim-chat-system")){aF.before('<div class="layim-chat-system"><span layim-event="chatLog">查看更多记录</span></div>')}if(aG>ay){aI.remove()}}aH.scrollTop(aH[0].scrollHeight+1000);aH.find("ul li:last").find("img").load(function(){aH.scrollTop(aH[0].scrollHeight+1000)})};var ae=function(){var aF=I(),v=aF.textarea;v.focus();v.off("keydown").on("keydown",function(aI){var aG=layui.data("layim")[D.mine.id]||{};var aH=aI.keyCode;if(aG.sendHotKey==="Ctrl+Enter"){if(aI.ctrlKey&&aH===13){i()}return}if(aH===13){if(aI.ctrlKey){return v.val(v.val()+"\n")}if(aI.shiftKey){return}aI.preventDefault();i()}})};var n=function(){var aF=["[微笑]","[嘻嘻]","[哈哈]","[可爱]","[可怜]","[挖鼻]","[吃惊]","[害羞]","[挤眼]","[闭嘴]","[鄙视]","[爱你]","[泪]","[偷笑]","[亲亲]","[生病]","[太开心]","[白眼]","[右哼哼]","[左哼哼]","[嘘]","[衰]","[委屈]","[吐]","[哈欠]","[抱抱]","[怒]","[疑问]","[馋嘴]","[拜拜]","[思考]","[汗]","[困]","[睡]","[钱]","[失望]","[酷]","[色]","[哼]","[鼓掌]","[晕]","[悲伤]","[抓狂]","[黑线]","[阴险]","[怒骂]","[互粉]","[心]","[伤心]","[猪头]","[熊猫]","[兔子]","[ok]","[耶]","[good]","[NO]","[赞]","[来]","[弱]","[草泥马]","[神马]","[囧]","[浮云]","[给力]","[围观]","[威武]","[奥特曼]","[礼物]","[钟]","[话筒]","[蜡烛]","[蛋糕]"],v={};layui.each(aF,function(aG,aH){v[aH]=layui.cache.dir+"images/face/"+aG+".gif"});return v}();var k=layui.stope;var aC=function(aF,aH){var v,aG=aF.value;aF.focus();if(document.selection){v=document.selection.createRange();document.selection.empty();v.text=aH}else{v=[aG.substring(0,aF.selectionStart),aH,aG.substr(aF.selectionEnd)];aF.focus();aF.value=v.join("")}};var O="layui-anim-upbit",t={status:function(aH,aI){var v=function(){aH.next().hide().removeClass(O)};var aF=aH.attr("lay-type");if(aF==="show"){k(aI);aH.next().show().addClass(O);au(document).off("click",v).on("click",v)}else{var aG=aH.parent().prev();aH.addClass(ac).siblings().removeClass(ac);aG.html(aH.find("cite").html());aG.removeClass("layim-status-"+(aF==="online"?"hide":"online")).addClass("layim-status-"+aF);layui.each(K.online,function(aJ,aK){aK&&aK(aF)})}},sign:function(){var v=L.find(".layui-layim-remark");v.on("change",function(){var aF=this.value;layui.each(K.sign,function(aG,aH){aH&&aH(aF)})});v.on("keyup",function(aG){var aF=aG.keyCode;if(aF===13){this.blur()}})},tab:function(aH){var aF,v=".layim-tab-content";var aG=L.find(".layui-layim-tab>li");typeof aH==="number"?(aF=aH,aH=aG.eq(aF)):(aF=aH.index());aF>2?aG.removeClass(ac):(t.tab.index=aF,aH.addClass(ac).siblings().removeClass(ac));L.find(v).eq(aF).addClass(Y).siblings(v).removeClass(Y)},spread:function(aH){var aG=aH.attr("lay-type");var aF=aG==="true"?"false":"true";var v=layui.data("layim")[D.mine.id]||{};aH.next()[aG==="true"?"removeClass":"addClass"](Y);v["spread"+aH.parent().index()]=aF;layui.data("layim",{key:D.mine.id,value:v});aH.attr("lay-type",aF);aH.find(".layui-icon").html(aF==="true"?"&#xe61a;":"&#xe602;")},search:function(aH){var aG=L.find(".layui-layim-search");var v=L.find("#layui-layim-search");var aF=aG.find("input"),aI=function(aR){var aJ=aF.val().replace(/\s/);if(aJ===""){t.tab(t.tab.index|0)}else{var aO=[],aL=D.friend||[];var aS=D.group||[],aQ="";for(var aP=0;aP<aL.length;aP++){for(var aM=0;aM<(aL[aP].list||[]).length;aM++){if(aL[aP].list[aM].username.indexOf(aJ)!==-1){aL[aP].list[aM].type="friend";aL[aP].list[aM].index=aP;aL[aP].list[aM].list=aM;aO.push(aL[aP].list[aM])}}}for(var aN=0;aN<aS.length;aN++){if(aS[aN].groupname.indexOf(aJ)!==-1){aS[aN].type="group";aS[aN].index=aN;aS[aN].list=aN;aO.push(aS[aN])}}if(aO.length>0){for(var aK=0;aK<aO.length;aK++){aQ+='<li layim-event="chat" data-type="'+aO[aK].type+'" data-index="'+aO[aK].index+'" data-list="'+aO[aK].list+'"><img src="'+aO[aK].avatar+'"><span>'+(aO[aK].username||aO[aK].groupname||"佚名")+"</span><p>"+(aO[aK].remark||aO[aK].sign||"")+"</p></li>"}}else{aQ='<li class="layim-null">无搜索结果</li>'}v.html(aQ);t.tab(3)}};if(!D.base.isfriend&&D.base.isgroup){t.tab.index=1}else{if(!D.base.isfriend&&!D.base.isgroup){t.tab.index=2}}aG.show();aF.focus();aF.off("keyup",aI).on("keyup",aI)},closeSearch:function(v){v.parent().hide();t.tab(t.tab.index|0)},msgbox:function(){var v=L.find(".layim-tool-msgbox");G.close(t.msgbox.index);v.find("span").removeClass(U).html("");return t.msgbox.index=G.open({type:2,title:"消息盒子",shade:false,maxmin:true,area:["600px","520px"],skin:"layui-box layui-layer-border",resize:false,content:D.base.msgbox})},find:function(){G.close(t.find.index);return t.find.index=G.open({type:2,title:"查找",shade:false,maxmin:true,area:["1000px","520px"],skin:"layui-box layui-layer-border",resize:false,content:D.base.find})},skin:function(){G.open({type:1,title:"更换背景",shade:false,area:"300px",skin:"layui-box layui-layer-border",id:"layui-layim-skin",zIndex:66666666,resize:false,content:B(av).render({skin:D.base.skin})})},about:function(){G.alert("版本： "+E+'<br>版权所有：<a href="http://layim.layui.com" target="_blank">layim.layui.com</a>',{title:"关于 LayIM",shade:false})},setSkin:function(aF){var aH=aF.attr("src");var v=layui.data("layim")[D.mine.id]||{};v.skin=aH;if(!aH){delete v.skin}layui.data("layim",{key:D.mine.id,value:v});try{L.css({"background-image":aH?"url("+aH+")":"none"});s.css({"background-image":aH?"url("+aH+")":"none"})}catch(aG){}layui.each(K.setSkin,function(aJ,aK){var aI=(aH||"").replace(layui.cache.dir+"css/modules/layim/skin/","");aK&&aK(aI,aH)})},chat:function(aF){var aM=layui.data("layim")[D.mine.id]||{};var aL=aF.data("type"),aJ=aF.data("index"),aI=au(aF).attr("class").trim().split(" ")[0].trim();var aK=aF.attr("data-list")||aF.index(),aG={};if(aL==="friend"){aK=D[aL][aJ].list;var aH=aI.split("-");if(aH.length==2){var v=undefined;if(aH[1].startsWith("friend")){v=aH[1].split("friend")[1]}}if(v){layui.each(aK,function(aN,aO){if(v==aO.id){aG=aO;return true}})}}else{if(aL==="group"){aG=D[aL][aK]}else{if(aL==="history"){aG=(aM.history||{})[aJ]||{}}}}aG.name=aG.name||aG.username||aG.groupname;if(aL!=="history"){aG.type=aL}r(aG)},tabChat:function(v){az(v)},closeChat:function(v,aF){az(v.parent(),1);k(aF)},closeThisChat:function(){az(null,1)},groupMembers:function(aH,aI){var aF=aH.find(".layui-icon"),v=function(){aF.html("&#xe61a;");aH.data("down",null);G.close(t.groupMembers.index)},aG=function(aJ){k(aJ)};if(aH.data("down")){v()}else{aF.html("&#xe619;");aH.data("down",true);t.groupMembers.index=G.tips('<ul class="layim-members-list"></ul>',aH,{tips:3,time:0,anim:5,fixed:true,skin:"layui-box layui-layim-members",success:function(aK){var aL=D.base.members||{},aM=I(),aO=aK.find(".layim-members-list"),aJ="",aP={},aQ=s.find(".layui-layer-max").hasClass("layui-layer-maxmin"),aN=s.find(".layim-chat-list").css("display")==="none";if(aQ){aO.css({width:au(window).width()-22-(aN||200)})}aL.data=au.extend(aL.data,{id:aM.data.id});l(aL,function(aR){layui.each(aR.list,function(aS,aT){aJ+='<li data-uid="'+aT.id+'"><a href="javascript:;"><img src="'+aT.avatar+'"><cite>'+aT.username+"</cite></a></li>";aP[aT.id]=aT});aJ+='<div data-type="del" class="layui-col-md6" style="text-align: right;padding-right: 5px;" title="删除群成员"><a href="javascript:;"><span style="color:#ccc;font-size: 60px;">-</span></a></div>';aJ+='<div data-type="add" class="layui-col-md6" style="text-align: left;padding-left: 5px;" title="添加群成员"><a href="javascript:;"><span style="color:#ccc;font-size: 60px;">+</span></a></div>';aO.html(aJ);aH.find(".layim-chat-members").html(aR.members||(aR.list||[]).length+"人");aO.find("li").on("click",function(){var aS=au(this).data("uid"),aT=aP[aS];r({name:aT.username,type:"friend",avatar:aT.avatar,id:aT.id});v()});aO.find("div").on("click",function(){var aS=au(this).data("type");if(aS==="add"){layui.each(K.groupAdd,function(aT,aU){aU&&aU(aM.data.id)})}else{if(aS==="del"){layui.each(K.groupDel,function(aT,aU){aU&&aU(aM.data.id)})}}v()});layui.each(K.members,function(aS,aT){aT&&aT(aR)})});aK.on("mousedown",function(aR){k(aR)})}});au(document).off("mousedown",v).on("mousedown",v);au(window).off("resize",v).on("resize",v);aH.off("mousedown",aG).on("mousedown",aG)}},send:function(){i()},setSend:function(aH,aI){var aG=t.setSend.box=aH.siblings(".layim-menu-box"),aF=aH.attr("lay-type");if(aF==="show"){k(aI);aG.show().addClass(O);au(document).off("click",t.setSendHide).on("click",t.setSendHide)}else{aH.addClass(ac).siblings().removeClass(ac);var v=layui.data("layim")[D.mine.id]||{};v.sendHotKey=aF;layui.data("layim",{key:D.mine.id,value:v});t.setSendHide(aI,aH.parent())}},setSendHide:function(aF,v){(v||t.setSend.box).hide().removeClass(O)},face:function(aH,aI){var aG="",v=I();for(var aF in n){aG+='<li title="'+aF+'"><img src="'+n[aF]+'"></li>'}aG='<ul class="layui-clear layim-face-list">'+aG+"</ul>";t.face.index=G.tips(aG,aH,{tips:1,time:0,fixed:true,skin:"layui-box layui-layim-face",success:function(aJ){aJ.find(".layim-face-list>li").on("mousedown",function(aK){k(aK)}).on("click",function(){aC(v.textarea[0],"face"+this.title+" ");G.close(t.face.index)})}});au(document).off("mousedown",t.faceHide).on("mousedown",t.faceHide);au(window).off("resize",t.faceHide).on("resize",t.faceHide);k(aI)},faceHide:function(){G.close(t.face.index)},image:function(aI){var aH=aI.data("type")||"images",aG={images:"uploadImage",file:"uploadFile"},aF=I(),v=D.base[aG[aH]]||{};layui.upload.render({url:v.url||"",method:v.type,elem:aI.find("input")[0],accept:aH,done:function(aJ){if(aJ.code==0){aJ.data=aJ.data||{};if(aH==="images"){aC(aF.textarea[0],"img["+(aJ.data.src||"")+"]")}else{if(aH==="file"){aC(aF.textarea[0],"file("+(aJ.data.src||"")+")["+(aJ.data.name||"下载文件")+"]")}}i()}else{G.msg(aJ.msg||"上传失败")}}})},media:function(aG){var aF=aG.data("type"),aH={audio:"音频",video:"视频"},v=I();G.prompt({title:"请输入网络"+aH[aF]+"地址",shade:false,offset:[aG.offset().top-au(window).scrollTop()-158+"px",aG.offset().left+"px"]},function(aJ,aI){aC(v.textarea[0],aF+"["+aJ+"]");i();G.close(aI)})},extend:function(aG){var aF=aG.attr("lay-filter"),v=I();layui.each(K["tool("+aF+")"],function(aH,aI){aI&&aI.call(aG,function(aJ){aC(v.textarea[0],aJ)},i,v)})},playAudio:function(aG){var v=aG.data("audio"),aF=v||document.createElement("audio"),aH=function(){aF.pause();aG.removeAttr("status");aG.find("i").html("&#xe652;")};if(aG.data("error")){return G.msg("播放音频源异常")}if(!aF.play){return G.msg("您的浏览器不支持audio")}if(aG.attr("status")){aH()}else{v||(aF.src=aG.data("src"));aF.play();aG.attr("status","pause");aG.data("audio",aF);aG.find("i").html("&#xe651;");aF.onended=function(){aH()};aF.onerror=function(){G.msg("播放音频源异常");aG.data("error",true);aH()}}},playVideo:function(aG){var aF=aG.data("src"),v=document.createElement("video");if(!v.play){return G.msg("您的浏览器不支持video")}G.close(t.playVideo.index);t.playVideo.index=G.open({type:1,title:"播放视频",area:["460px","300px"],maxmin:true,shade:false,content:'<div style="background-color: #000; height: 100%;"><video style="position: absolute; width: 100%; height: 100%;" src="'+aF+'" loop="loop" autoplay="autoplay"></video></div>'})},chatLog:function(aF){var v=I();if(!D.base.chatLog){return G.msg("未开启更多聊天记录")}G.close(t.chatLog.index);return t.chatLog.index=G.open({type:2,maxmin:true,title:"与 "+v.data.name+" 的聊天记录",area:["450px","100%"],shade:false,offset:"rb",skin:"layui-box",anim:2,id:"layui-layim-chatlog",content:D.base.chatLog+"?id="+v.data.id+"&type="+v.data.type})},menuHistory:function(aJ,aL){var aG=layui.data("layim")[D.mine.id]||{};var aI=aJ.parent(),aH=aJ.data("type");var aF=L.find(".layim-list-history");var v='<li class="layim-null">暂无历史会话</li>';if(aH==="one"){var aK=aG.history;delete aK[aI.data("index")];aG.history=aK;layui.data("layim",{key:D.mine.id,value:aG});aF.find(".layim-"+aI.data("index")).remove();if(aF.find("li").length===0){aF.html(v)}}else{if(aH==="all"){delete aG.history;layui.data("layim",{key:D.mine.id,value:aG});aF.html(v)}}G.closeAll("tips")},menuChat:function(aH,aI){var v=layui.data("layim")[D.mine.id]||{};var aG=aH.parent(),aF=aH.data("type");var aK=aG.data("cid");var aJ=h(aK);if(null!=aJ){if(aF==="del"){aj(aJ);layui.each(K.delMessage,function(aL,aM){aM&&aM(aJ)});G.msg("你删除了一条消息!")}else{if(aF==="withdraw"){if(aJ.mine){if((new Date()-aJ.timestamp)/60000<a){aB(aJ);layui.each(K.withdraw,function(aL,aM){aM&&aM(aJ)})}else{G.msg("超过["+a+"]分钟的消息无法撤回！")}}else{G.msg("该消息不支持撤回")}}else{if(aF==="resend"){if(aJ.mine){Z(aJ.cid,"sending");ao(aJ.cid,aJ.content)}else{G.msg("该消息不支持重发")}}}}}else{G.msg("该消息不支持任何操作..")}G.closeAll("tips")}};M("layim",new y())}).addcss("modules/layim/layim.css?v=3.7.7","skinlayimcss");